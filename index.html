<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√¢n T√≠ch Baccarat To√†n Di·ªán (AI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c101b;
            color: #F9FAFB;
        }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn:active { transform: translateY(1px); }
        .card-glow-p { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .card-glow-b { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        .card-glow-wait { box-shadow: 0 0 20px rgba(156, 163, 175, 0.4); }

        .road-grid {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 24px;
            gap: 2px;
            overflow-x: auto;
            padding: 8px;
            min-height: 160px;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        .road-col {
            display: grid;
            grid-auto-rows: 24px;
            gap: 2px;
        }
        .road-item {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: white;
            position: relative;
        }
        .road-item-big { border-radius: 9999px; border: 2px solid; }
        .road-item-p { border-color: #3b82f6; color: #3b82f6; }
        .road-item-b { border-color: #ef4444; color: #ef4444; }
        .road-item-t { background-color: #10b981; border-radius: 9999px; }

        /* Tie Slash */
        .tie-slash {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #10b981;
            transform: rotate(-45deg);
        }

        /* Pair Dots */
        .pair-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .pair-dot.p-pair { background-color: #3b82f6; top: 2px; right: 2px; }
        .pair-dot.b-pair { background-color: #ef4444; bottom: 2px; left: 2px; }

        .bead-plate-item-p { background-color: #3b82f6; border-radius: 9999px;}
        .bead-plate-item-b { background-color: #ef4444; border-radius: 9999px;}
        
        /* Corrected Derived Road Styles */
        .derived-item { width: 10px; height: 10px; border-radius: 9999px; }
        /* Big Eye Boy: Hollow. P (Pattern) = Red, B (No Pattern) = Blue */
        .big-eye-boy-p { border: 2px solid #ef4444; }
        .big-eye-boy-b { border: 2px solid #3b82f6; }
        /* Small Road: Solid. P (Pattern) = Red, B (No Pattern) = Blue */
        .small-road-p { background-color: #ef4444; }
        .small-road-b { background-color: #3b82f6; }
        /* Cockroach Pig: Slash. P (Pattern) = Red, B (No Pattern) = Blue */
        .cockroach-pig-p { border: 1px solid #ef4444; background: linear-gradient(to top right, transparent calc(50% - 0.5px), #ef4444, transparent calc(50% + 0.5px)); }
        .cockroach-pig-b { border: 1px solid #3b82f6; background: linear-gradient(to top right, transparent calc(50% - 0.5px), #3b82f6, transparent calc(50% + 0.5px)); }
        
        /* Custom Checkbox */
        .pair-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-900">

<div class="max-w-screen-xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left Column: Input & History -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Header -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-red-400">H·ªá Th·ªëng Ph√¢n T√≠ch Baccarat To√†n Di·ªán</h1>
            <p class="text-gray-400 mt-2">S·ª≠ D·ª•ng Tr√≠ Tu·ªá Nh√¢n T·∫°o Gemini</p>
        </div>
        
        <!-- Controls -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold text-blue-300">‚öôÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn</h2>
                 <button onclick="openSettingsModal()" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-cog fa-lg"></i></button>
             </div>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <button onclick="addResult('P')" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-6 rounded-lg text-2xl">
                    <span>üë§</span> CON
                </button>
                 <button onclick="addResult('T')" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-6 rounded-lg text-2xl">
                    <span>ü§ù</span> H√íA
                </button>
                <button onclick="addResult('B')" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-6 rounded-lg text-2xl">
                    <span>üè¶</span> C√ÅI
                </button>
            </div>

            <div class="flex items-center justify-center gap-6 mb-4 text-white">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="playerPair" class="w-5 h-5 rounded border-2 border-blue-400 text-blue-500 focus:ring-blue-500 pair-checkbox appearance-none">
                    <span>Con ƒê√¥i</span>
                </label>
                 <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="bankerPair" class="w-5 h-5 rounded border-2 border-red-400 text-red-500 focus:ring-red-500 pair-checkbox appearance-none">
                    <span>C√°i ƒê√¥i</span>
                </label>
            </div>

            <div class="flex gap-4">
                <button onclick="undoLast()" class="btn flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">‚Ü©Ô∏è Ho√†n T√°c</button>
                <button onclick="clearHistory()" class="btn flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg">üóëÔ∏è X√≥a L·ªãch S·ª≠</button>
            </div>
        </div>

        <!-- History Display -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-blue-300">üìú C√°c B·∫£ng C·∫ßu</h2>
                    <span class="text-gray-400 font-medium text-sm">T·ªïng: <span id="totalGames">0</span> v√°n</span>
                </div>
                <!-- Stats -->
                <div id="statsContainer" class="text-right text-xs space-y-1 text-gray-300 bg-gray-900/50 p-2 rounded-md">
                    <!-- Stats content here -->
                </div>
            </div>

            <div class="grid grid-cols-12 gap-2">
                <!-- Main Roads -->
                <div class="col-span-12 md:col-span-8 space-y-2">
                    <div class="bg-gray-900 rounded-lg border border-gray-700">
                        <div id="beadPlateDisplay" class="road-grid"></div>
                    </div>
                    <div class="bg-gray-900 rounded-lg border border-gray-700">
                        <div id="bigRoadDisplay" class="road-grid"></div>
                    </div>
                </div>
                <!-- Derived Roads -->
                <div class="col-span-12 md:col-span-4 space-y-2">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 grid grid-cols-2">
                        <div id="bigEyeBoyDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div>
                        <div id="pAskDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1 border-l-2 border-gray-700"></div>
                    </div>
                     <div class="bg-gray-900 rounded-lg border border-gray-700 grid grid-cols-2">
                        <div id="smallRoadDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div>
                        <div id="bAskDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1 border-l-2 border-gray-700"></div>
                    </div>
                     <div class="bg-gray-900 rounded-lg border border-gray-700">
                        <div id="cockroachPigDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Right Column: Analysis & Stats -->
    <div class="space-y-6">
        <div id="analysis-card" class="bg-gray-800 p-6 rounded-2xl shadow-lg transition-shadow duration-500 sticky top-6">
            <h2 class="text-xl font-semibold mb-4 text-yellow-300 flex items-center gap-2">
                <i class="fa-solid fa-brain"></i> Ph√¢n T√≠ch & ƒê·ªÅ Xu·∫•t t·ª´ Gemini AI
            </h2>
            <div id="analysisResult" class="space-y-4 min-h-[300px]"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden"></div>

<script>
// --- GLOBAL STATE & CONFIG ---
let state = {
    history: [], // now stores objects: { winner, pPair, bPair }
    apiKey: '',
    isAnalyzing: false,
};
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';

// --- ROADMAP GENERATION LOGIC ---
class BaccaratRoadmapGenerator {
    generateBigRoad(history) {
        const columns = [];
        if (history.length === 0) return columns;

        let currentCol = [];
        let lastWinner = null;

        history.forEach(item => {
            if (item.winner === 'T') {
                if (currentCol.length > 0) {
                    currentCol[currentCol.length - 1].ties = (currentCol[currentCol.length - 1].ties || 0) + 1;
                } else if (columns.length > 0) {
                    const prevCol = columns[columns.length - 1];
                    prevCol[prevCol.length - 1].ties = (prevCol[prevCol.length - 1].ties || 0) + 1;
                }
            } else {
                const bead = { winner: item.winner, pPair: item.pPair, bPair: item.bPair, ties: 0 };
                if (item.winner === lastWinner) {
                    currentCol.push(bead);
                } else {
                    if (currentCol.length > 0) columns.push(currentCol);
                    currentCol = [bead];
                    lastWinner = item.winner;
                }
            }
        });
        if (currentCol.length > 0) columns.push(currentCol);
        return columns;
    }

    generateDerivedRoads(bigRoad, hypotheticalWinner = null) {
        let tempBigRoad = JSON.parse(JSON.stringify(bigRoad));
        if (hypotheticalWinner) {
            const lastCol = tempBigRoad[tempBigRoad.length - 1];
            if (lastCol && lastCol[0].winner === hypotheticalWinner) {
                lastCol.push({ winner: hypotheticalWinner });
            } else {
                tempBigRoad.push([{ winner: hypotheticalWinner }]);
            }
        }
        
        const results = { bigEyeBoy: [], smallRoad: [], cockroachPig: [] };
        for (let i = 0; i < tempBigRoad.length; i++) {
            for (let j = 0; j < tempBigRoad[i].length; j++) {
                // Determine starting points accurately
                if ((i === 1 && j === 1) || i > 1) this.addDerivedResult(results.bigEyeBoy, tempBigRoad, i, j, 1);
                if ((i === 2 && j === 1) || i > 2) this.addDerivedResult(results.smallRoad, tempBigRoad, i, j, 2);
                if ((i === 3 && j === 1) || i > 3) this.addDerivedResult(results.cockroachPig, tempBigRoad, i, j, 3);
            }
        }
        return results;
    }

    addDerivedResult(road, bigRoad, i, j, offset) {
        const result = this.compare(bigRoad, i, j, offset);
        if (result) road.push(result);
    }

    compare(bigRoad, i, j, offset) {
        let isPattern; // true for Red (P), false for Blue (B)
        if (j === 0) {
            // Vertical drop comparison
            const prevCol = bigRoad[i - 1];
            const refCol = bigRoad[i - 1 - offset];
            if (!prevCol || !refCol) return null;
            isPattern = prevCol.length === refCol.length;
        } else {
            // Dragon tail comparison
            const refCol = bigRoad[i - offset];
            if (!refCol) return null;
            const hasBeadAtDepth = !!refCol[j];
            const hasBeadAtPrevDepth = !!refCol[j - 1];
            isPattern = hasBeadAtDepth === hasBeadAtPrevDepth;
        }
        return { winner: isPattern ? 'P' : 'B' }; // P for Pattern (Red), B for No Pattern (Blue)
    }
}
const roadmapGenerator = new BaccaratRoadmapGenerator();

// --- UI RENDERING FUNCTIONS ---
function renderAllRoads() {
    const history = state.history;
    const bigRoad = roadmapGenerator.generateBigRoad(history);

    renderBeadPlateUI(history);
    renderBigRoadUI(bigRoad);
    
    const derivedRoads = roadmapGenerator.generateDerivedRoads(bigRoad);
    renderDerivedRoadUI('bigEyeBoyDisplay', derivedRoads.bigEyeBoy, 'big-eye-boy');
    renderDerivedRoadUI('smallRoadDisplay', derivedRoads.smallRoad, 'small-road');
    renderDerivedRoadUI('cockroachPigDisplay', derivedRoads.cockroachPig, 'cockroach-pig');

    updatePredictionProbes(bigRoad);
    updateStatsUI(history);
}

function renderBeadPlateUI(data) {
    const container = document.getElementById('beadPlateDisplay');
    container.innerHTML = '';
    const maxRows = 6;
    let currentCol = document.createElement('div');
    currentCol.className = 'road-col';
    data.forEach((item, index) => {
        if (index > 0 && index % maxRows === 0) {
            container.appendChild(currentCol);
            currentCol = document.createElement('div');
            currentCol.className = 'road-col';
        }
        const itemDiv = document.createElement('div');
        const colorClass = item.winner === 'P' ? 'bead-plate-item-p' : item.winner === 'B' ? 'bead-plate-item-b' : 'road-item-t';
        itemDiv.className = `road-item ${colorClass}`;
        itemDiv.textContent = item.winner;
        if (item.pPair) itemDiv.innerHTML += '<div class="pair-dot p-pair"></div>';
        if (item.bPair) itemDiv.innerHTML += '<div class="pair-dot b-pair"></div>';
        currentCol.appendChild(itemDiv);
    });
    if (currentCol.hasChildNodes()) container.appendChild(currentCol);
    container.scrollLeft = container.scrollWidth;
}

function renderBigRoadUI(columns) {
    const container = document.getElementById('bigRoadDisplay');
    container.innerHTML = '';
    columns.forEach(colData => {
        const colDiv = document.createElement('div');
        colDiv.className = 'road-col';
        colData.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `road-item road-item-big road-item-${item.winner.toLowerCase()}`;
            if (item.pPair) itemDiv.innerHTML += '<div class="pair-dot p-pair"></div>';
            if (item.bPair) itemDiv.innerHTML += '<div class="pair-dot b-pair"></div>';
            if (item.ties > 0) {
                itemDiv.innerHTML += `<div class="tie-slash"></div>`;
                if(item.ties > 1) itemDiv.innerHTML += `<span class="absolute text-xs font-bold text-white">${item.ties}</span>`;
            }
            colDiv.appendChild(itemDiv);
        });
        container.appendChild(colDiv);
    });
    container.scrollLeft = container.scrollWidth;
}

function renderDerivedRoadUI(containerId, data, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    if (data.length === 0) return;
    const columns = roadmapGenerator.generateBigRoad(data); // Reuse big road logic for display
    columns.forEach(colData => {
        const colDiv = document.createElement('div');
        colDiv.className = 'road-col !grid-auto-rows-[10px]';
        colData.forEach(item => {
            const itemDiv = document.createElement('div');
            const color = item.winner === 'P' ? 'p' : 'b'; // P is Red, B is Blue in derived
            itemDiv.className = `derived-item ${type}-${color}`;
            colDiv.appendChild(itemDiv);
        });
        container.appendChild(colDiv);
    });
    container.scrollLeft = container.scrollWidth;
}

function updatePredictionProbes(bigRoad) {
    const pAskContainer = document.getElementById('pAskDisplay');
    const bAskContainer = document.getElementById('bAskDisplay');
    pAskContainer.innerHTML = '';
    bAskContainer.innerHTML = '';

    // Player Ask
    const pProbeRoads = roadmapGenerator.generateDerivedRoads(bigRoad, 'P');
    const pBigEyeNext = pProbeRoads.bigEyeBoy[pProbeRoads.bigEyeBoy.length - 1];
    const pSmallNext = pProbeRoads.smallRoad[pProbeRoads.smallRoad.length - 1];
    const pCockroachNext = pProbeRoads.cockroachPig[pProbeRoads.cockroachPig.length - 1];
    
    let pAskHTML = '<div class="road-col !grid-auto-rows-[10px]">';
    if(pBigEyeNext) pAskHTML += `<div class="derived-item big-eye-boy-${pBigEyeNext.winner.toLowerCase()}"></div>`;
    if(pSmallNext) pAskHTML += `<div class="derived-item small-road-${pSmallNext.winner.toLowerCase()}"></div>`;
    if(pCockroachNext) pAskHTML += `<div class="derived-item cockroach-pig-${pCockroachNext.winner.toLowerCase()}"></div>`;
    pAskHTML += '</div>';
    pAskContainer.innerHTML = pAskHTML;

    // Banker Ask
    const bProbeRoads = roadmapGenerator.generateDerivedRoads(bigRoad, 'B');
    const bBigEyeNext = bProbeRoads.bigEyeBoy[bProbeRoads.bigEyeBoy.length - 1];
    const bSmallNext = bProbeRoads.smallRoad[bProbeRoads.smallRoad.length - 1];
    const bCockroachNext = bProbeRoads.cockroachPig[bProbeRoads.cockroachPig.length - 1];
    
    let bAskHTML = '<div class="road-col !grid-auto-rows-[10px]">';
    if(bBigEyeNext) bAskHTML += `<div class="derived-item big-eye-boy-${bBigEyeNext.winner.toLowerCase()}"></div>`;
    if(bSmallNext) bAskHTML += `<div class="derived-item small-road-${bSmallNext.winner.toLowerCase()}"></div>`;
    if(bCockroachNext) bAskHTML += `<div class="derived-item cockroach-pig-${bCockroachNext.winner.toLowerCase()}"></div>`;
    bAskHTML += '</div>';
    bAskContainer.innerHTML = bAskHTML;
}

function updateStatsUI(history) {
    const stats = { P: 0, B: 0, T: 0, pPair: 0, bPair: 0 };
    history.forEach(h => {
        stats[h.winner] = (stats[h.winner] || 0) + 1;
        if(h.pPair) stats.pPair++;
        if(h.bPair) stats.bPair++;
    });
    document.getElementById('statsContainer').innerHTML = `
        <div>C√°i: ${stats.B}</div>
        <div>Con: ${stats.P}</div>
        <div>H√≤a: ${stats.T}</div>
        <div>C√°i ƒê√¥i: ${stats.bPair}</div>
        <div>Con ƒê√¥i: ${stats.pPair}</div>
    `;
}

// --- CORE ACTIONS ---
function addResult(winner) {
    if (state.isAnalyzing) return;
    const pPair = document.getElementById('playerPair').checked;
    const bPair = document.getElementById('bankerPair').checked;
    
    state.history.push({ winner, pPair, bPair });
    
    document.getElementById('totalGames').textContent = state.history.length;
    document.getElementById('playerPair').checked = false;
    document.getElementById('bankerPair').checked = false;
    
    renderAllRoads();
    saveState();
    triggerAIAnalysis();
}

function undoLast() {
    if (state.history.length === 0 || state.isAnalyzing) return;
    state.history.pop();
    document.getElementById('totalGames').textContent = state.history.length;
    renderAllRoads();
    saveState();
    triggerAIAnalysis();
}

function clearHistory() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ v√°n b√†i kh√¥ng?')) {
        state.history = [];
        document.getElementById('totalGames').textContent = 0;
        renderAllRoads();
        saveState();
        updateAnalysisUI('<p class="text-gray-400 text-center py-8">L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a.</p>');
        document.getElementById('statsContainer').innerHTML = '';
    }
}


// --- SETTINGS & STATE MANAGEMENT ---
function openSettingsModal() {
    const modal = document.getElementById('settingsModal');
    modal.classList.remove('hidden');
    modal.innerHTML = `<div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-blue-300">C√†i ƒê·∫∑t</h2>
            <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-white text-3xl">&times;</button>
        </div>
        <div>
            <label for="apiKeyInput" class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
            <input type="password" id="apiKeyInput" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" value="${state.apiKey}">
             <p class="text-xs text-gray-500 mt-2">API Key ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát. <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">L·∫•y API Key</a>.</p>
        </div>
        <div class="mt-8 flex justify-end gap-4">
            <button onclick="closeSettingsModal()" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">H·ªßy</button>
            <button onclick="saveSettings()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg">L∆∞u</button>
        </div>
    </div>`;
}

function closeSettingsModal() {
     document.getElementById('settingsModal').classList.add('hidden');
}

function saveSettings() {
    state.apiKey = document.getElementById('apiKeyInput').value.trim();
    localStorage.setItem('baccaratAI_apiKey_v2', state.apiKey);
    closeSettingsModal();
    if (state.history.length > 0) triggerAIAnalysis();
}

function saveState() {
    localStorage.setItem('baccaratAI_history_v2', JSON.stringify(state.history));
}

function loadState() {
    const savedHistory = localStorage.getItem('baccaratAI_history_v2');
    const savedApiKey = localStorage.getItem('baccaratAI_apiKey_v2');
    if (savedHistory) state.history = JSON.parse(savedHistory);
    if (savedApiKey) state.apiKey = savedApiKey;
}
async function triggerAIAnalysis() {
    if (!state.apiKey) {
        updateAnalysisUI(`<div class="text-center py-8"><p class="text-yellow-400 font-semibold">Vui l√≤ng nh·∫≠p Gemini API Key!</p><p class="text-gray-400 mt-2 text-sm">Click v√†o icon <i class="fas fa-cog"></i> ƒë·ªÉ c√†i ƒë·∫∑t.</p></div>`);
        return;
    }
    if (state.history.length < 5) {
         updateAnalysisUI(`<p class="text-gray-400 text-center py-8">C·∫ßn √≠t nh·∫•t 5 v√°n ƒë·ªÉ ph√¢n t√≠ch...</p>`);
         return;
    }
    state.isAnalyzing = true;
    updateAnalysisUI(`<div class="flex flex-col items-center justify-center h-full py-8"><div class="w-10 h-10 border-4 border-t-blue-500 border-gray-600 rounded-full animate-spin"></div><p class="text-gray-400 mt-4 animate-pulse">Gemini ƒëang ph√¢n t√≠ch...</p></div>`);
    try {
        const prompt = createPrompt();
        const response = await fetch(`${GEMINI_API_URL}${state.apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{text: "You are a world-class Baccarat analyst. Your task is to analyze the provided game history and various roadmaps to predict the next outcome (Player or Banker). Your response MUST be in JSON format and NOTHING else. The JSON must contain: 'prediction' (either 'P' or 'B'), and 'reasoning' (a detailed explanation in Vietnamese, max 3-4 sentences, explaining the key patterns you identified that led to your prediction)."}] }
            })
        });
        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("No content in API response.");
        const parsedResult = JSON.parse(text.replace(/```json|```/g, ''));
        const { prediction, reasoning } = parsedResult;
        const glowClass = prediction === 'P' ? 'card-glow-p' : 'card-glow-b';
        document.getElementById('analysis-card').classList.add(glowClass);
        updateAnalysisUI(`<div class="bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold text-gray-200 mb-2">L√Ω Do ƒê·ªÅ Xu·∫•t:</h4><p class="text-gray-300 text-sm leading-relaxed">${reasoning}</p></div><div class="text-center bg-gray-900 py-6 rounded-lg border-2 ${prediction === 'P' ? 'border-blue-500' : 'border-red-500'}"><p class="text-lg text-gray-400 mb-2">AI ƒê·ªÅ xu·∫•t:</p><p class="text-4xl font-bold mt-2 ${prediction === 'P' ? 'text-blue-400' : 'text-red-400'}">${prediction === 'P' ? 'üë§ CON' : 'üè¶ C√ÅI'}</p></div>`);
    } catch (error) {
        console.error("AI Analysis Error:", error);
        updateAnalysisUI(`<div class="text-center py-8 text-red-400"><p class="font-semibold">L·ªói ph√¢n t√≠ch!</p><p class="text-sm mt-2">${error.message}.</p></div>`);
    } finally {
        state.isAnalyzing = false;
    }
}
function createPrompt() {
    const historyString = state.history.map(h=>h.winner).join(', ');
    const bigRoad = roadmapGenerator.generateBigRoad(state.history);
    const derivedRoads = roadmapGenerator.generateDerivedRoads(bigRoad);
    const bigRoadText = bigRoad.map(col => col.map(c => c.winner).join('')).join(' | ');
    const bigEyeBoyText = derivedRoads.bigEyeBoy.map(i => i.winner).join('').replace(/P/g, 'R').replace(/B/g, 'B'); // R for Red, B for Blue
    const smallRoadText = derivedRoads.smallRoad.map(i => i.winner).join('').replace(/P/g, 'R').replace(/B/g, 'B');
    const cockroachPigText = derivedRoads.cockroachPig.map(i => i.winner).join('').replace(/P/g, 'R').replace(/B/g, 'B');
    return `Baccarat Analysis: History: ${historyString}. Big Road: ${bigRoadText}. Big Eye Boy (R=Pattern, B=Choppy): ${bigEyeBoyText}. Small Road (R=Pattern, B=Choppy): ${smallRoadText}. Cockroach Pig (R=Pattern, B=Choppy): ${cockroachPigText}. Predict NEXT result (P or B).`;
}
function updateAnalysisUI(content) {
    const analysisResultDiv = document.getElementById('analysisResult');
    const analysisCard = document.getElementById('analysis-card');
    analysisCard.classList.remove('card-glow-p', 'card-glow-b', 'card-glow-wait');
    analysisResultDiv.innerHTML = content;
}
// --- INITIALIZATION ---
function initializeApp() {
    loadState();
    document.getElementById('totalGames').textContent = state.history.length;
    renderAllRoads();
    if(state.history.length > 0) {
        triggerAIAnalysis();
    } else {
        updateAnalysisUI('<p class="text-gray-400 text-center py-8">Ch√†o m·ª´ng! H√£y nh·∫≠p k·∫øt qu·∫£ v√°n b√†i ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>')
    }
}
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>

